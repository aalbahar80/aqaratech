<script lang="ts">
	import { page, session } from '$app/stores';
	import Form from '$lib/components/form/Form.svelte';
	import { labelHint } from '$lib/constants/form-hints';
	import { Field } from '$lib/models/classes/Field.class';
	import { OrganizationIdField } from '$lib/utils/form/organization-id-field';
	import { schema } from '$models/schemas/portfolio.schema';
	import type { PortfolioDto } from '@self/sdk';

	type TPortfolioDto = $$Generic<
		TPortfolios extends undefined ? PortfolioDto : undefined
	>;

	interface Props {
		formType: 'create' | 'update';
	}

	interface UpdateForm extends Props {
		formType: 'update';
		data: TPortfolioDto;
	}

	interface CreateForm extends Props {
		formType: 'create';
	}

	type $$Props = CreateForm | UpdateForm;

	export let formType: $$Props['formType'];
	export let data: TPortfolioDto = undefined as TPortfolioDto;

	const basicFields = [
		OrganizationIdField(
			data?.organizationId || $session.user?.role?.organizationId,
		),
		new Field('fullName', {
			required: true,
			value: data?.fullName,
			label: 'Portfolio Name (full)',
		}),
		new Field('label', {
			value: data?.label,
			hint: labelHint,
		}),
		new Field('phone', { value: data?.phone }),
		new Field('civilid', {
			label: 'Civil ID',
			value: data?.civilid,
		}),
		new Field('dob', {
			type: 'date',
			label: 'Date of Birth',
			value: data?.dob?.split('T')[0],
		}),
	];
</script>

{#if formType === 'update'}
	<Form
		{schema}
		entity="portfolio"
		{formType}
		{basicFields}
		onSubmit={(values) =>
			data && // type hack
			$page.stuff.api.portfolios.update({
				id: data.id,
				updatePortfolioDto: values,
			})}
	/>
{:else}
	<Form
		{schema}
		entity="portfolio"
		{formType}
		{basicFields}
		onSubmit={(values) => {
			return $page.stuff.api.portfolios.create({
				createPortfolioDto: values,
			});
		}}
	/>
{/if}
